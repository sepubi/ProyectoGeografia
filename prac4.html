<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualización ZONAS_VALIDAS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/shpjs@3.5.0/dist/shp.min.js"></script>
    <script>
        // Inicializar el mapa
        var map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Capa para zonas
        var zonasLayer = L.geoJSON(null, {
            style: function(){ return {color: '#ff5722', weight: 2, fillOpacity: 0.2}; },
            onEachFeature: function(feature, layer){
                var props = feature.properties || {};
                var info = Object.keys(props).map(function(k){ return '<b>'+k+':</b> '+props[k]; }).join('<br>');
                if(info) layer.bindPopup(info);
            }
        }).addTo(map);

        // Fallback GeoJSON (ejemplo) — se usará si no hay archivos en la raíz
        var ejemplo = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"id":1},"geometry":{"type":"Polygon","coordinates":[[[-3.693051776999949,40.42861623500005],[-3.692485854999939,40.42776840700008],[-3.691924610999946,40.42801452400006],[-3.692482319999942,40.42885408600005],[-3.693051776999949,40.42861623500005]]]}}]};

        function addGeoJSON(data){
            zonasLayer.clearLayers();
            zonasLayer.addData(data);
            try{ map.fitBounds(zonasLayer.getBounds()); }catch(e){ map.setView([40.4286, -3.6930], 14); }
        }

        // Intentar cargar GeoJSON, ZIP o directamente .shp + .dbf en la raíz
        function tryLoadFiles(){
            var geojsonCandidates = ['../ZONAS_VALIDAS.geojson','ZONAS_VALIDAS.geojson'];
var zipCandidates = [
    'pdf/ZONAS_VALIDAS.zip',
    '../pdf/ZONAS_VALIDAS.zip'
];
var shpCandidates = [
    'pdf/ZONAS_VALIDAS.zip',
    '../pdf/ZONAS_VALIDAS.zip'
];
var dbfCandidates = [
    'pdf/ZONAS_VALIDAS.zip',
    '../pdf/ZONAS_VALIDAS.zip'
];
    

            // 1) Intentar GeoJSON
            fetch(geojsonCandidates[0]).then(function(r){
                if(r.ok) return r.json();
                return fetch(geojsonCandidates[1]).then(function(r2){ if(r2.ok) return r2.json(); throw new Error('no-geojson'); });
            }).then(function(json){
                addGeoJSON(json);
                hideInfo();
            }).catch(function(){
                // 2) Intentar ZIP (shapefile comprimido)
                fetch(zipCandidates[0]).then(function(r){
                    if(r.ok) return r.arrayBuffer();
                    return fetch(zipCandidates[1]).then(function(r2){ if(r2.ok) return r2.arrayBuffer(); throw new Error('no-zip'); });
                }).then(function(buf){
                    shp(buf).then(function(geojson){
                        addGeoJSON(geojson);
                        hideInfo();
                    }).catch(function(err){
                        console.error('error parse shp zip',err);
                        showInfo('Error al leer el ZIP. Revisa que el ZIP contenga .shp, .shx y .dbf.');
                        addGeoJSON(ejemplo);
                    });
                }).catch(function(){
                    // 3) Intentar leer directamente el .shp (sin zip) — mostrará geometrías; intentamos también .dbf para atributos
                    fetch(shpCandidates[0]).then(function(r){
                        if(r.ok) return r.arrayBuffer();
                        return fetch(shpCandidates[1]).then(function(r2){ if(r2.ok) return r2.arrayBuffer(); throw new Error('no-shp'); });
                    }).then(function(shpBuf){
                        var geometries;
                        try{
                            geometries = shp.parseShp(shpBuf);
                        }catch(e){
                            console.error('Error parseShp', e);
                            showInfo('Error al leer el .shp directamente.');
                            addGeoJSON(ejemplo);
                            return;
                        }

                        // Intentar cargar DBF para atributos
                        fetch(dbfCandidates[0]).then(function(rdb){
                            if(rdb.ok) return rdb.arrayBuffer();
                            return fetch(dbfCandidates[1]).then(function(rdb2){ if(rdb2.ok) return rdb2.arrayBuffer(); throw new Error('no-dbf'); });
                        }).then(function(dbfBuf){
                            var records = [];
                            try{ records = shp.parseDbf(dbfBuf); }catch(e){ console.warn('parseDbf falló', e); }
                            // Construir FeatureCollection
                            var features = [];
                            // geometries puede ser FeatureCollection o un array de geometries
                            var geomsArray = geometries.features ? geometries.features.map(f=>f.geometry) : (Array.isArray(geometries)?geometries:[]);
                            for(var i=0;i<geomsArray.length;i++){
                                features.push({type:'Feature', properties: records[i]||{}, geometry: geomsArray[i]});
                            }
                            addGeoJSON({type:'FeatureCollection', features:features});
                            hideInfo();
                        }).catch(function(){
                            // No hay DBF — construir con geometrías sólo
                            var features = [];
                            var geomsArray = geometries.features ? geometries.features.map(f=>f.geometry) : (Array.isArray(geometries)?geometries:[]);
                            for(var i=0;i<geomsArray.length;i++){
                                features.push({type:'Feature', properties: {}, geometry: geomsArray[i]});
                            }
                            showInfo('Se cargó el .shp directamente (sin atributos, falta .dbf).');
                            addGeoJSON({type:'FeatureCollection', features:features});
                        });

                    }).catch(function(){
                        // 4) Nada encontrado: mostrar instrucciones y fallback
                        showInfo('No se encontró ZONAS_VALIDAS (.geojson .zip o .shp) en la raíz. Coloca "ZONAS_VALIDAS.shp" (y opcionalmente .dbf) en la raíz del repo. Se mostrará un ejemplo.');
                        addGeoJSON(ejemplo);
                    });
                });
            });
        }

        // UI de información (mensaje superior derecho)
        var infoDiv = document.createElement('div');
        infoDiv.style.position = 'absolute';
        infoDiv.style.top = '12px';
        infoDiv.style.right = '12px';
        infoDiv.style.zIndex = 1000;
        infoDiv.style.background = 'rgba(2,31,47,0.85)';
        infoDiv.style.color = '#fff';
        infoDiv.style.padding = '10px 14px';
        infoDiv.style.borderRadius = '8px';
        infoDiv.style.boxShadow = '0 6px 18px rgba(0,0,0,0.4)';
        infoDiv.style.maxWidth = '320px';
        infoDiv.innerHTML = '';
        document.body.appendChild(infoDiv);

        function showInfo(msg){ infoDiv.innerHTML = msg; infoDiv.style.display='block'; }
        function hideInfo(){ infoDiv.style.display='none'; }

        // Ejecutar intento de carga
        tryLoadFiles();
    </script>
</body>
</html>